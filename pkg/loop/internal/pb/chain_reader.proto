syntax = "proto3";

option go_package = "github.com/smartcontractkit/chainlink-common/pkg/loop/internal/pb";

package loop;

import "codec.proto";
import "google/protobuf/empty.proto";

service ChainReader {
  // TODO replies
  rpc GetLatestValue (GetLatestValueRequest) returns (GetLatestValueReply) {}
  rpc QueryKey (QueryKeyRequest) returns (QueryKeysReply) {}
  rpc QueryKeys (QueryKeysRequest) returns (QueryKeysReply) {}
  rpc QueryKeyByValues (QueryKeyByValuesRequest) returns (QueryKeysReply) {}
  rpc QueryKeysByValues (QueryKeysByValuesRequest) returns (QueryKeysReply) {}
  rpc Bind(BindRequest) returns (google.protobuf.Empty) {}
}

message AndFilter {
  repeated QueryFilter filters = 1;
}

message AddressFilter {
  repeated string addresses = 1;
}

message Keys {
  repeated string keys = 1;
}

message Values {
  repeated string values = 1;
}


enum Confirmations {
  Finalized   = 0;
  Unconfirmed = 1;
}

message ConfirmationsFilter{
  Confirmations confirmations = 1;
}

enum ComparisonOperator {
    Eq = 0;
    Neq = 1;
    Gt = 2;
    Lt = 3;
    Gte = 4;
    Lte = 5;
}

message BlockFilter{
  uint64 block_number = 1;
  ComparisonOperator operator = 2;
}

message TimestampFilter{
  uint64 timestamp = 1;
  ComparisonOperator operator = 2;
}

message TxHashFilter{
  string tx_hash = 1;
}

enum SortDirection {
  Asc = 0;
  Desc = 1;
}

message SortByTimestamp {
  SortDirection sort_direction = 1;
}

message SortByBlock {
  SortDirection sort_direction = 1;
}

message SortBySequence {
  SortDirection sort_direction = 1;
}

message SortBy {
  oneof sort_by {
    SortByTimestamp sort_by_timestamp = 1;
    SortByBlock sort_by_block = 2;
    SortBySequence sort_by_sequence = 3;
  }
}

message LimitAndSort{
  uint64 limit = 1;
  repeated SortBy sort_by = 2;
}

message KeyValues{
  repeated string value = 1;
}

message QueryFilter {
  oneof filter {
    AndFilter and_filter = 1;
    AddressFilter address_filter = 2;
    ConfirmationsFilter confirmations_filter = 3;
    BlockFilter block_filter = 4;
    TimestampFilter timestamp_filter = 5;
    TxHashFilter tx_hash_filter = 6;
  }
}

// QueryKeysByValuesRequest has arguments for [github.com/smartcontractkit/chainlink-common/pkg/types.ChainReader.QueryKeyRequest].
message QueryKeyRequest {
  string key = 1;
  QueryFilter filter = 2;
  LimitAndSort limit_and_sort = 3;
}

// QueryKeysByValuesRequest has arguments for [github.com/smartcontractkit/chainlink-common/pkg/types.ChainReader.QueryKeysRequest].
message QueryKeysRequest {
  repeated string keys = 1;
  QueryFilter filter = 2;
  LimitAndSort limit_and_sort = 3;
}

// QueryKeysByValuesRequest has arguments for [github.com/smartcontractkit/chainlink-common/pkg/types.ChainReader.QueryKeyByValuesRequest].
message QueryKeyByValuesRequest {
  string key = 1;
  KeyValues values = 2;
  QueryFilter filter = 3;
  LimitAndSort limit_and_sort = 4;
}

// QueryKeysByValuesRequest has arguments for [github.com/smartcontractkit/chainlink-common/pkg/types.ChainReader.QueryKeysByValues].
message QueryKeysByValuesRequest {
  repeated string keys = 1;
  repeated KeyValues values = 2;
  QueryFilter filter = 3;
  LimitAndSort limit_and_sort = 4;
}

// GetLatestValueRequest has arguments for [github.com/smartcontractkit/chainlink-common/pkg/types.ChainReader.GetLatestValue].
message GetLatestValueRequest {
  string contractName = 1;
  string method = 2;
  VersionedBytes params = 3;
}

// GetLatestValueReply has return arguments for [github.com/smartcontractkit/chainlink-common/pkg/types.ChainReader.GetLatestValue].
message GetLatestValueReply {
  VersionedBytes retVal = 1;
}

// QueryKeysReply has return arguments for [github.com/smartcontractkit/chainlink-common/pkg/types.ChainReader.QueryKeys].
message QueryKeysReply {
  VersionedBytes retVal = 1;
}

message BindRequest {
  repeated BoundContract bindings = 1;
}

// BoundContract represents a [github.com/smartcontractkit/chainlink-common/pkg/types.BoundContract].
message BoundContract {
  string address = 1;
  string name = 2;
  bool pending = 3;
}
